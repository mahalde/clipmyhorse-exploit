const puppeteer = require("puppeteer");

async function scrapeVideo(url) {
  const browser = await puppeteer.launch({ args: ["--no-sandbox"] });
  try {
    const page = await browser.newPage();

    let playlistURLs = [];

    page.on("response", async (response) => {
      if (response.url().includes("playerdata")) {
        const resJson = await response.json();

        playlistURLs = resJson.streams.map((stream) => stream.playlistfile);
      }
    });

    await page.goto(url);

    const partElements = (await page.$$(".video-links a")).slice(1);

    const parts = (
      await Promise.all(
        partElements.map(
          async (el) => await (await el.getProperty("textContent")).jsonValue()
        )
      )
    ).map((part) => part.trim());

    await browser.close();

    const res = parts.reduce((prev, cur, i) => {
      prev[cur] = playlistURLs[i];
      return prev;
    }, {});

    return res;
  } catch (e) {
    await browser.close();
    throw e;
  }
}

module.exports = { scrapeVideo };
